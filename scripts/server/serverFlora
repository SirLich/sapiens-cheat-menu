local gameObject = require "common/gameObject"
local flora = mjrequire "common/flora"
local saveState = mjrequire "hammerstone/state/saveState"

local serverGOM = nil


local serverFlora = {}
local mod = {
	loadOrder = 1,
}

--shadow growSapling function
local function growSapling(loadedObject)
    local saplingObjectTypeIndex = loadedObject.objectTypeIndex
    local gameObjectType = gameObject.types[saplingObjectTypeIndex]
    if gameObjectType.floraTypeIndex then
        local floraInfo = flora.types[gameObjectType.floraTypeIndex]
        local newTypeIndex = floraInfo.gameObjectTypeIndex
        if newTypeIndex ~= saplingObjectTypeIndex then
            local reloadedSharedState = loadedObject.sharedState
            
            reloadedSharedState:remove("matureTime")

            local growFruitImmediately = floraInfo.fruitImmediatelyWhenMature
            
            if (not growFruitImmediately) and ((not floraInfo.fruitFrequencyInYears) or floraInfo.fruitFrequencyInYears == 1) then
                local soilQuality = serverFlora:getGrowthMediumQuality(loadedObject)
                if soilQuality == flora.soilQualities.rich then
                    growFruitImmediately = true
                end
            end
            

            if growFruitImmediately then
                serverFlora:refillInventory(loadedObject, reloadedSharedState, true, true)
            else
                serverFlora:refillInventory(loadedObject, reloadedSharedState, true, false)
                reloadedSharedState:set("growFruitNextSeasonIndex", floraInfo.fruitSeason)
                reloadedSharedState:set("growFruitYearDelayCounter", (floraInfo.fruitFrequencyInYears or 1))
            end

            serverGOM:changeObjectType(loadedObject.uniqueID, newTypeIndex, false) --calls object loaded function, which calls addCallbackToLoadFruit if needed 
            serverGOM:updateNearByObjectObservers(loadedObject.uniqueID, newTypeIndex, saplingObjectTypeIndex)
        end
    end
end

local function init()
	-- Register net function for cheats
        mod.server:registerNetFunction("growSapling", growSapling)
end

function mod:onload(serverFlora)
	local super_init = serverFlora.init
	serverFlora.init = function(self, serverGOM, serverWorld, serverTribe)
		super_init(self, serverGOM, serverWorld, serverTribe)
	end

    local super_growSapling = serverFlora.growSapling
    serverFlora.growSapling = function(self, loadedObject)
        super_growSapling(self, loadedObject)
    end
    
    init()
end


return mod